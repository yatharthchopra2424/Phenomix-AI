"""
knowledge_base.py
=================
Seeds ChromaDB with CPIC / PharmGKB guideline text chunks on first startup.

Each chunk is ~400–600 tokens and covers one gene-drug-phenotype combination.
Text is sourced from CPIC guidelines (cpicpgx.org) and PharmGKB annotations.

In a production deployment, these chunks would be generated by ingesting the
official CPIC PDF guidelines through a recursive character-text splitter
(LangChain / LlamaIndex) and embedding them at build time.  For this prototype
the text is stored inline for zero-dependency seeding.
"""

from __future__ import annotations

import logging
import uuid
from typing import List

from rag_pipeline.chroma_client import get_collection, collection_is_empty
from rag_pipeline.embedder import embed_texts

logger = logging.getLogger(__name__)


# ---------------------------------------------------------------------------
# CPIC / PharmGKB guideline chunks
# ---------------------------------------------------------------------------
# Each entry is a dict with text_payload + metadata fields.
# ---------------------------------------------------------------------------

_CHUNKS = [
    # ── CYP2D6 / CODEINE ─────────────────────────────────────────────────────
    {
        "text": (
            "CPIC Guideline for Codeine and CYP2D6 (v1.3)\n\n"
            "Gene: CYP2D6\nDrug: Codeine\n\n"
            "Codeine is an opioid prodrug that requires hepatic conversion to morphine "
            "via the cytochrome P450 2D6 (CYP2D6) enzyme for analgesic activity. "
            "The CYP2D6 gene is highly polymorphic, and metabolic phenotype varies "
            "significantly across populations.\n\n"
            "Ultra-Rapid Metabolizers (UM, AS > 2.0): Gene duplication events "
            "(e.g. CYP2D6 *1xN, *2xN) cause accelerated conversion of codeine to "
            "morphine. This results in unpredictably high systemic morphine concentrations, "
            "greatly increasing the risk of life-threatening respiratory depression, "
            "bradycardia, and opioid overdose. Postoperative deaths have been reported in "
            "paediatric UM patients. CPIC recommends AVOIDING codeine in UMs and "
            "prescribing an alternative analgesic (tramadol with caution, or non-opioid).\n\n"
            "Poor Metabolizers (PM, AS = 0.0): Homozygous or compound heterozygous "
            "loss-of-function variants (e.g. *4/*4, rs3892097) result in absent CYP2D6 "
            "activity. The conversion of codeine to morphine does not occur. Patients "
            "experience NO analgesic effect from codeine at standard doses. CPIC "
            "recommends AVOIDING codeine and prescribing a non-CYP2D6-dependent "
            "analgesic (e.g. morphine, oxycodone). The most prevalent loss-of-function "
            "allele globally is CYP2D6 *4 (rs3892097), a splice site defect at nucleotide "
            "2850.\n\n"
            "Intermediate Metabolizers (IM, AS 0.5–1.4): Reduced analgesic efficacy "
            "expected. Consider dose reduction or alternative.\n\n"
            "Normal Metabolizers (NM, AS 1.5–2.0): Standard dosing appropriate."
        ),
        "metadata": {
            "source_type": "CPIC_Guideline",
            "gene": "CYP2D6",
            "drug": "CODEINE",
            "phenotype": "all",
        },
    },
    {
        "text": (
            "CYP2D6 *4 Allele Detail — rs3892097 (1846G>A splice site variant)\n\n"
            "CYP2D6 *4 is the most common non-functional allele in European populations "
            "(frequency ~20%). The 1846G>A transition at position chr22:42524947 (hg38) "
            "disrupts the CYP2D6 intron 3 / exon 4 splice donor site, resulting in "
            "aberrant mRNA splicing and production of a truncated, catalytically inactive "
            "protein. Homozygous *4/*4 genotype confers the Poor Metabolizer phenotype "
            "with an Activity Score of 0.0. Heterozygous carriers (*1/*4) are typically "
            "classified as Normal Metabolizers (AS=1.0) for most CYP2D6 substrates. "
            "CYP2D6 *10 (rs1065852, 100C>T, AS=0.25) is the most prevalent "
            "decreased-function allele in East Asian populations, conferring Intermediate "
            "Metabolizer phenotype when combined with a second decreased- or no-function allele."
        ),
        "metadata": {
            "source_type": "PharmGKB",
            "gene": "CYP2D6",
            "drug": "CODEINE",
            "phenotype": "Poor Metabolizer",
        },
    },
    # ── CYP2C19 / CLOPIDOGREL ───────────────────────────────────────────────
    {
        "text": (
            "CPIC Guideline for Clopidogrel and CYP2C19 (v1.3)\n\n"
            "Gene: CYP2C19\nDrug: Clopidogrel\n\n"
            "Clopidogrel (Plavix) is a thienopyridine antiplatelet prodrug requiring "
            "two-step hepatic bioactivation, predominantly mediated by CYP2C19, to its "
            "active thiol metabolite which irreversibly inhibits the platelet P2Y12 "
            "receptor and reduces ADP-induced platelet aggregation.\n\n"
            "Poor Metabolizers (PM, AS = 0.0): CYP2C19 loss-of-function alleles "
            "*2 (rs4244285, 681G>A) and *3 (rs4986893, 636G>A) cause near-complete "
            "absence of active metabolite generation. Clinical studies (TRITON-TIMI 38, "
            "PLATO) demonstrate that PM patients have significantly higher rates of major "
            "adverse cardiovascular events (MACE), stent thrombosis, and stroke than NMs. "
            "CPIC strongly recommends alternative antiplatelet agents: PRASUGREL "
            "(where not contraindicated) or TICAGRELOR.\n\n"
            "Intermediate Metabolizers (IM, AS 0.5–1.4): Reduced active metabolite "
            "formation. CPIC recommends considering alternative therapy or increased "
            "clopidogrel dose after platelet function testing.\n\n"
            "Ultra-Rapid Metabolizers (UM, *17/*17, rs12248560): Enhanced CYP2C19 "
            "activity may increase bleeding risk. Consider platelet reactivity testing."
        ),
        "metadata": {
            "source_type": "CPIC_Guideline",
            "gene": "CYP2C19",
            "drug": "CLOPIDOGREL",
            "phenotype": "all",
        },
    },
    # ── CYP2C9 / WARFARIN ───────────────────────────────────────────────────
    {
        "text": (
            "CPIC Guideline for Warfarin and CYP2C9 / VKORC1 / CYP4F2 (v1.4)\n\n"
            "Gene: CYP2C9\nDrug: Warfarin\n\n"
            "Warfarin (Coumadin) is a vitamin K antagonist anticoagulant with a narrow "
            "therapeutic index, primarily metabolised by CYP2C9 (S-warfarin, the more "
            "potent enantiomer). CYP2C9 genetic variation significantly alters dose "
            "requirements and bleeding risk.\n\n"
            "Poor Metabolizers (PM — *3/*3, *2/*3, AS ≈ 0.0–0.5): Markedly reduced "
            "warfarin clearance leads to drug accumulation, supratherapeutic INR, and "
            "dangerous haemorrhagic complications. CYP2C9 *3 (rs1057910, Ile359Leu) "
            "reduces enzymatic activity by >90%. CPIC recommends initiating warfarin at "
            "≥50% dose reduction with extremely intensive INR monitoring. Consider "
            "direct oral anticoagulants (DOACs) such as rivaroxaban or apixaban as "
            "genotype-independent alternatives.\n\n"
            "Intermediate Metabolizers (IM — *1/*2, *1/*3, AS 0.5–1.4): Reduce "
            "starting dose by 25–50%. CPIC dosing algorithm (inclusive of CYP2C9 + "
            "VKORC1 genotype) is strongly recommended.\n\n"
            "CYP2C9 *2 (rs1799853, Arg144Cys, chr10:96741053): approximately 11% allele "
            "frequency in Europeans; reduces S-warfarin clearance by ~30%."
        ),
        "metadata": {
            "source_type": "CPIC_Guideline",
            "gene": "CYP2C9",
            "drug": "WARFARIN",
            "phenotype": "all",
        },
    },
    # ── SLCO1B1 / SIMVASTATIN ───────────────────────────────────────────────
    {
        "text": (
            "CPIC Guideline for Simvastatin and SLCO1B1 (v2.0)\n\n"
            "Gene: SLCO1B1\nDrug: Simvastatin\n\n"
            "SLCO1B1 (Solute Carrier Organic Anion Transporter Family Member 1B1) "
            "encodes the OATP1B1 protein that mediates hepatic uptake of statins from "
            "portal blood. Reduced OATP1B1 transport function causes elevated systemic "
            "simvastatin acid concentrations, increasing the risk of statin-induced "
            "myopathy and rhabdomyolysis.\n\n"
            "SLCO1B1 *5 (rs4149056, Val174Ala, c.521T>C, chr12:21178615): The most "
            "clinically significant variant. The *5 allele reduces OATP1B1 transport "
            "function by ~60%. Heterozygous carriers have a 4.5-fold increased risk of "
            "myopathy with simvastatin 80 mg (SEARCH trial). Homozygous *5/*5 carriers "
            "have ~17-fold increased risk.\n\n"
            "Decreased Function (transport): CPIC recommends avoiding simvastatin "
            "doses >20 mg/day or switching to pravastatin, rosuvastatin, or fluvastatin "
            "(alternative OATP1B1 substrates or non-substrates with lower myopathy risk).\n\n"
            "Poor Function: Avoid all simvastatin. Prescribe pravastatin (renal/biliary "
            "elimination) or rosuvastatin with lowest effective dose.\n\n"
            "SLCO1B1 *15 (compound haplotype containing rs2306283 [A388G] + rs4149056) "
            "is also associated with reduced transport function."
        ),
        "metadata": {
            "source_type": "CPIC_Guideline",
            "gene": "SLCO1B1",
            "drug": "SIMVASTATIN",
            "phenotype": "all",
        },
    },
    # ── TPMT / AZATHIOPRINE ─────────────────────────────────────────────────
    {
        "text": (
            "CPIC Guideline for Azathioprine / 6-Mercaptopurine / Thioguanine and TPMT (v1.3)\n\n"
            "Gene: TPMT\nDrug: Azathioprine\n\n"
            "Thiopurine S-methyltransferase (TPMT) is the primary enzyme catabolising "
            "azathioprine and its active metabolite 6-mercaptopurine (6-MP). When TPMT "
            "activity is reduced, thiopurine nucleotides accumulate in haematopoietic "
            "cells, causing severe myelosuppression.\n\n"
            "Poor Metabolizers (PM — biallelic loss-of-function, e.g. *3A/*3A, *3C/*3C):"
            "TPMT activity is absent or near-absent. Standard dose azathioprine causes "
            "severe, potentially fatal bone-marrow failure (leukopenia, thrombocytopenia, "
            "anaemia). CPIC recommends reducing dose by 10-fold or switching to "
            "non-thiopurine immunosuppressant.\n\n"
            "TPMT *3C (rs1142345, Thr240Cys, chr6:18131006) is the most common "
            "no-function allele globally. TPMT *3A is a compound haplotype (*3B + *3C). "
            "TPMT *2 (rs1800462, Ala80Pro, chr6:18130943) is less frequent.\n\n"
            "Intermediate Metabolizers (IM — one no-function allele): Reduce azathioprine "
            "starting dose by 30–70%, allow 2–4 weeks between dose escalations, and "
            "monitor CBC weekly for the first month.\n\n"
            "Normal Metabolizers: Standard dosing per clinical indication."
        ),
        "metadata": {
            "source_type": "CPIC_Guideline",
            "gene": "TPMT",
            "drug": "AZATHIOPRINE",
            "phenotype": "all",
        },
    },
    # ── DPYD / FLUOROURACIL ─────────────────────────────────────────────────
    {
        "text": (
            "CPIC Guideline for Fluorouracil / Capecitabine and DPYD (v1.2)\n\n"
            "Gene: DPYD\nDrug: Fluorouracil\n\n"
            "Dihydropyrimidine dehydrogenase (DPD), encoded by DPYD, is the rate-limiting "
            "enzyme for catabolism of the chemotherapy agents fluorouracil (5-FU) and "
            "capecitabine. DPYD deficiency leads to dramatically elevated 5-FU exposure "
            "and life-threatening toxicity.\n\n"
            "Poor Metabolizers (PM — biallelic loss-of-function): Complete DPYD deficiency "
            "results in severe, early-onset systemic toxicity: profound neutropenia, "
            "febrile neutropenia, severe mucositis, GI haemorrhage, and treatment-related "
            "death. CPIC recommends AVOIDING fluorouracil and capecitabine entirely, or "
            "administering at ≤10% of standard dose only if no alternative exists with "
            "intensive pharmacokinetic monitoring.\n\n"
            "DPYD *2A (rs3918290, IVS14+1G>A, chr1:97915614): splice site variant; most "
            "severe, no-function allele. Frequency ~1% in Europeans.\n\n"
            "DPYD *13 (rs56038477, Ile543Val, chr1:97981395): no function; associated "
            "with severe 5-FU toxicity.\n\n"
            "Decreased Function Variants (c.2846A>T rs67376798, HapB3 rs75017182): "
            "Intermediate phenotype. CPIC recommends 25–50% dose reduction with "
            "close toxicity monitoring.\n\n"
            "Normal Metabolizers: Standard fluorouracil therapy is appropriate."
        ),
        "metadata": {
            "source_type": "CPIC_Guideline",
            "gene": "DPYD",
            "drug": "FLUOROURACIL",
            "phenotype": "all",
        },
    },
]


# ---------------------------------------------------------------------------
# Seeding function
# ---------------------------------------------------------------------------

def seed_knowledge_base() -> None:
    """
    Populate the ChromaDB pharma_guidelines collection with guideline chunks.
    Skipped if the collection already contains documents (idempotent).
    """
    if not collection_is_empty():
        logger.info("Knowledge base already seeded (%d docs). Skipping.", get_collection().count())
        return

    collection = get_collection()
    texts     = [c["text"] for c in _CHUNKS]
    metadatas = [c["metadata"] for c in _CHUNKS]
    ids       = [str(uuid.uuid4()) for _ in _CHUNKS]

    logger.info("Embedding %d guideline chunks…", len(texts))
    embeddings = embed_texts(texts)

    collection.add(
        ids        = ids,
        embeddings = embeddings,
        documents  = texts,
        metadatas  = metadatas,
    )
    logger.info("Knowledge base seeded successfully with %d chunks.", len(texts))


# Avoid circular import at module level
from rag_pipeline.chroma_client import get_collection  # noqa: E402 (re-import for clarity)
